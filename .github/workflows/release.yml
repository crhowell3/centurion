name: Release

on:
    release:
        types: [published]

permissions:
    contents: write

env:
    RUSTFLAGS: -Dwarnings

jobs:
    publish:
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: macos-latest
                      rust_targets: "aarch64-apple-darwin"
                      args: "--target aarch64-apple-darwin"

                    - platform: macos-latest
                      rust_targets: "x86_64-apple-darwin"
                      args: "--target x86_64-apple-darwin"

                    - platform: windows-latest
                      rust_targets: ""
                      args: ""

                    - platform: ubuntu-22.04
                      rust_targets: ""
                      args: ""

        runs-on: ${{ matrix.platform }}

        steps:
            - uses: actions/checkout@v4

            - name: Install Linux dependencies
              if: matrix.platform == 'ubuntu-22.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    libasound2-dev \
                    libwebkit2gtk-4.1-dev \
                    libayatana-appindicator3-dev \
                    libgtk-3-dev \
                    librsvg2-dev \
                    patchelf

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.rust_targets }}

            - name: Install wasm target + trunk
              run: |
                  rustup target add wasm32-unknown-unknown
                  cargo install --locked trunk

            - name: Cache Rust
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: "./src-tauri -> target"

            - name: Build & Upload Release Assets
              uses: tauri-apps/tauri-action@v0
              with:
                  tagName: ${{ github.event.release.tag_name }}
                  releaseName: ${{ github.event.release.name }}
                  releaseBody: ${{ github.event.release.body }}
                  releaseDraft: false
                  prerelease: ${{ github.event.release.prerelease }}
                  args: ${{ matrix.args }}
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
