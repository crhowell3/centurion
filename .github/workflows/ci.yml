name: CI

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

permissions:
    contents: read

env:
    RUSTFLAGS: -Dwarnings

jobs:
    build:
        strategy:
            fail-fast: false
            matrix:
                include:
                    - platform: macos-latest
                      args: "--target aarch64-apple-darwin"
                      rust_targets: "aarch64-apple-darwin"
                      label: "macos-arm64"

                    - platform: macos-latest
                      args: "--target x86_64-apple-darwin"
                      rust_targets: "x86_64-apple-darwin"
                      label: "macos-intel"

                    - platform: windows-latest
                      args: ""
                      rust_targets: ""
                      label: "windows-x64"

                    - platform: ubuntu-22.04
                      args: ""
                      rust_targets: ""
                      label: "linux-x64"

                    - platform: ubuntu-24.04
                      args: ""
                      rust_targets: ""
                      label: "linux-x64"

        runs-on: ${{ matrix.platform}}

        steps:
            - uses: actions/checkout@v4

            - name: install dependencies (ubuntu)
              if: matrix.platform == 'ubuntu-22.04' || matrix.platform == 'ubuntu-24.04'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    libasound2-dev \
                    libwebkit2gtk-4.1-dev \
                    libayatana-appindicator3-dev \
                    libgtk-3-dev \
                    librsvg2-dev \
                    patchelf

            - name: install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.rust_targets }}

            - name: Install wasm target + trunk
              run: |
                  rustup target add wasm32-unknown-unknown
                  cargo install --locked trunk

            - name: Rust cache
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: "./src-tauri -> target"

            - name: build (all targets)
              uses: tauri-apps/tauri-action@v0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    clippy:
        name: Clippy
        runs-on: ubuntu-latest
        permissions: write-all
        timeout-minutes: 45
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@clippy
            - run: cargo install clippy-sarif sarif-fmt
            - run: rustup component add --toolchain stable-x86_64-unknown-linux-gnu clippy
            - run: cargo clippy
                  --all-features
                  --message-format=json
                  -- -Dclippy::all -Dclippy::pedantic | clippy-sarif | tee rust-clippy-results.sarif | sarif-fmt
              continue-on-error: true
            - uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: rust-clippy-results.sarif
                  wait-for-processing: true
