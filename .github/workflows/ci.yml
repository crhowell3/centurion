name: CI

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]

permissions:
    contents: read

env:
    RUSTFLAGS: -Dwarnings

jobs:
    build_and_test:
        name: Build and test
        runs-on: ubuntu-latest
        timeout-minutes: 45
        steps:
            - uses: actions/checkout@v4
            - run: cargo tauri build

    clippy:
        name: Clippy
        runs-on: ubuntu-latest
        permissions: write-all
        timeout-minutes: 45
        steps:
            - uses: actions/checkout@v4
            - uses: dtolnay/rust-toolchain@clippy
            - run: cargo install clippy-sarif sarif-fmt
            - run: rustup component add --toolchain stable-x86_64-unknown-linux-gun clippy
            - run: cargo clippy
                  --all-features
                  --message-format=json
                  -- -Dclippy::all -Dclippy::pedantic | clippy-sarif | tee rust-clippy-results.sarif | sarif-fmt
              continue-on-error: true
            - uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: rust-clippy-results.sarif
                  wait-for-processing: true
